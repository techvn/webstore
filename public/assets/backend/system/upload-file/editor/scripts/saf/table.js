function getNextSibling(b){if(!b){return null}var a=b.nextSibling;while(true){if(a==null){return null}if(a.nodeType==1&&(a.tagName=="TD"||a.tagName=="TR")){return a}a=a.nextSibling}}function getSpanNum(a){if(a==null){return 1}return parseInt(a)}function getNumOfColumns(b){var a=0;for(var f=0;f<b.rows.length;f++){var e=0;var d=b.rows[f];for(var c=0;c<d.cells.length;c++){var g=d.cells[c];e+=getSpanNum(g.getAttribute("COLSPAN"))}if(e>a){a=e}}return a}function getCurrentRowLayout(oTable,oTR){var numOfCols=getNumOfColumns(oTable);var sTmp="[";for(var i=1;i<=numOfCols;i++){sTmp+="false,"}sTmp=sTmp.substr(0,sTmp.length-1);sTmp+="]";var arrAllCols=eval(sTmp);for(var i=0;i<oTR.rowIndex;i++){var oTR_tmp=oTable.rows[i];var m=0;for(var j=0;j<oTR_tmp.cells.length;j++){var oTD_tmp=oTR_tmp.cells[j];var cSpan=getSpanNum(oTD_tmp.getAttribute("COLSPAN"));m+=cSpan;if(getSpanNum(oTD_tmp.getAttribute("ROWSPAN"))>=oTR.rowIndex+1-i){for(var k=0;k<cSpan;k++){arrAllCols[m-1+k]=true}}}}return arrAllCols}function getAbsoluteCellIndex(a,e,g){var h=getCurrentRowLayout(a,e);var b=0;var d=false;for(var c=0;c<e.cells.length;c++){if(d==false){b+=getSpanNum(e.cells[c].getAttribute("COLSPAN"))}if(g==e.cells[c]){d=true}}b=b-(getSpanNum(g.getAttribute("COLSPAN"))-1);for(var c=0;c<b;c++){if(h[c]==true){b++}}var f=b;return f}function getNextRowLayout(oTable,oTR,oTD){var nCellIndex=getAbsoluteCellIndex(oTable,oTR,oTD);var numOfCols=getNumOfColumns(oTable);var sTmp="[";for(i=1;i<=numOfCols;i++){sTmp+="false,"}sTmp=sTmp.substr(0,sTmp.length-1);sTmp+="]";var arrTmp=eval(sTmp);var bFinish=false;var oTR_tmp=oTR;var rSpan=getSpanNum(oTD.getAttribute("ROWSPAN"));for(var k=0;k<rSpan;k++){oTR_tmp=getNextSibling(oTR_tmp)}if(!oTR_tmp){return null}for(var i=0;i<oTR_tmp.rowIndex;i++){var oTR_before=oTable.rows[i];for(var j=0;j<oTR_before.cells.length;j++){var oTD_before=oTR_before.cells[j];if(getSpanNum(oTD_before.getAttribute("ROWSPAN"))>=oTR_tmp.rowIndex+1-i){var cSpan=getSpanNum(oTD_before.getAttribute("COLSPAN"));for(k=0;k<cSpan;k++){var indx=getAbsoluteCellIndex(oTable,oTR_before,oTD_before);arrTmp[indx-1+k]=true}}}}return arrTmp}function spanRow(){var m=parent.oUtil.oEditor;var c=m.getSelection();var f=parent.getSelectedElement(c);var n=GetElement(f,"TD");if(n==null){return}var e=GetElement(f,"TR");if(e==null){return}var l=GetElement(f,"TABLE");if(l==null){return}var b=getNumOfColumns(l);var a=getAbsoluteCellIndex(l,e,n);oTR_tmp=e;for(var d=0;d<n.rowSpan;d++){oTR_tmp=getNextSibling(oTR_tmp)}if(!oTR_tmp){return false}var h=getNextRowLayout(l,e,n);nCount=0;for(i=0;i<a;i++){if(h[i]==true){nCount++}}numOfTrue=nCount;nCount=numOfTrue;iResult=0;bFinish=false;for(i=0;i<oTR_tmp.cells.length;i++){oTD_tmp=oTR_tmp.cells[i];var g=getSpanNum(oTD_tmp.getAttribute("COLSPAN"));nCount+=g;if(nCount>=a&&bFinish==false){nCount=nCount-(g-1);if(nCount==a){if(g==getSpanNum(n.getAttribute("COLSPAN"))){nn=getSpanNum(oTD_tmp.getAttribute("ROWSPAN"));iResult=i;bFinish=true}else{return false}}else{return false}}}nTmp=getSpanNum(n.getAttribute("ROWSPAN"));n.setAttribute("ROWSPAN",nTmp+nn);oTR_tmp.deleteCell(iResult);return true}function splitRow(){var m=parent.oUtil.oEditor;var d=m.getSelection();var f=parent.getSelectedElement(d);var n=GetElement(f,"TD");if(n==null){return}var e=GetElement(f,"TR");if(e==null){return}var l=GetElement(f,"TABLE");if(l==null){return}if(getSpanNum(n.getAttribute("ROWSPAN"))==1){return}var b=getNumOfColumns(l);var a=getAbsoluteCellIndex(l,e,n);if(!getNextSibling(e)){return}var h=getCurrentRowLayout(l,getNextSibling(e));nCount=0;for(i=0;i<a;i++){if(h[i]==true){nCount++}}numOfTrue=nCount;nPoint=a-numOfTrue;nCount=0;iResult=0;oTR_tmp=getNextSibling(e);bFinish=false;for(i=0;i<oTR_tmp.cells.length;i++){oTD_tmp=oTR_tmp.cells[i];var g=getSpanNum(oTD_tmp.getAttribute("COLSPAN"));nCount+=g;if(nCount>nPoint&&bFinish==false){iResult=i;bFinish=true}else{if(bFinish==false){iResult=i+1}}}nTmp=getSpanNum(n.getAttribute("ROWSPAN"));n.setAttribute("ROWSPAN",1);var c=oTR_tmp.insertCell(iResult);c.innerHTML="New Cell";c.setAttribute("ROWSPAN",nTmp-1);c.style.cssText=oTD_tmp.style.cssText}function spanCol(){var f=parent.oUtil.oEditor;var a=f.getSelection();var d=parent.getSelectedElement(a);var e=GetElement(d,"TD");if(e==null){return}var c=GetElement(d,"TR");if(c==null){return}var b=GetElement(d,"TABLE");if(b==null){return}if(getNextSibling(e)){if(getSpanNum(e.getAttribute("ROWSPAN"))==getSpanNum(getNextSibling(e).getAttribute("ROWSPAN"))){e.setAttribute("COLSPAN",getSpanNum(e.getAttribute("COLSPAN"))+getSpanNum(getNextSibling(e).getAttribute("COLSPAN")));c.deleteCell(getNextSibling(e).cellIndex)}}}function splitCol(){var f=parent.oUtil.oEditor;var a=f.getSelection();var d=parent.getSelectedElement(a);var e=GetElement(d,"TD");if(e==null){return}var c=GetElement(d,"TR");if(c==null){return}var b=GetElement(d,"TABLE");if(b==null){return}if(getSpanNum(e.getAttribute("COLSPAN"))==1){return}if(getNextSibling(e)){if(getSpanNum(e.getAttribute("ROWSPAN"))!=getSpanNum(getNextSibling(e).getAttribute("ROWSPAN"))){return}}e.setAttribute("COLSPAN",getSpanNum(e.getAttribute("COLSPAN"))-1);var g=c.insertCell(e.cellIndex+1);g.innerHTML="New Cell";g.style.cssText=e.style.cssText}function doInsertRow(a){if(a=="Above"){rowOperation(false,true,false,false)}else{rowOperation(false,false,true,false)}}function doInsertCol(a){if(a=="Left"){colOperation(false,true,false,false)}else{colOperation(false,false,true,false)}}function doDelRow(){rowOperation(false,false,false,true)}function doDelCol(){colOperation(false,false,false,true)}function colOperation(bGetArrayCells,bDoInsertColumnLeft,bDoInsertColumnRight,bDeleteColumn){var oEditor=parent.oUtil.oEditor;var oSel=oEditor.getSelection();var element=parent.getSelectedElement(oSel);var oTD=GetElement(element,"TD");if(oTD==null){return}var oTR=GetElement(element,"TR");if(oTR==null){return}var oTable=GetElement(element,"TABLE");if(oTable==null){return}var bCannotDelete=false;sArrCols="";var nCellIndex=getAbsoluteCellIndex(oTable,oTR,oTD);nColSpan=getSpanNum(oTD.getAttribute("COLSPAN"));for(var i=0;i<oTable.rows.length;i++){var oTR_tmp=oTable.rows[i];arrTmp=getCurrentRowLayout(oTable,oTR_tmp);if(arrTmp[nCellIndex-1]!=true){nCount=0;for(j=0;j<nCellIndex;j++){if(arrTmp[j]==true){nCount++}}numOfTrue=nCount;nCount=numOfTrue;bFinish=false;for(k=0;k<oTR_tmp.cells.length;k++){oTD_tmp=oTR_tmp.cells[k];var cSpan=getSpanNum(oTD_tmp.getAttribute("COLSPAN"));nCount+=cSpan;if(nCount>=nCellIndex&&bFinish==false){nCount=nCount-(cSpan-1);if(nCount==nCellIndex){if(bDoInsertColumnLeft||bDoInsertColumnRight){if(cSpan>1){oTD_tmp.setAttribute("COLSPAN",cSpan+1)}else{if(bDoInsertColumnLeft){var oNewCell=oTR_tmp.insertCell(oTD_tmp.cellIndex);oNewCell.style.cssText=oTD_tmp.style.cssText;oNewCell.innerHTML="New Cell";oNewCell.setAttribute("ROWSPAN",getSpanNum(oTD_tmp.getAttribute("ROWSPAN")))}else{var oNewCell=oTR_tmp.insertCell(oTD_tmp.cellIndex+1);oNewCell.style.cssText=oTD_tmp.style.cssText;oNewCell.innerHTML="New Cell";oNewCell.setAttribute("ROWSPAN",getSpanNum(oTD_tmp.getAttribute("ROWSPAN")))}}}if(cSpan==nColSpan){sArrCols+="["+i+","+oTD_tmp.cellIndex+"],"}else{sArrCols+="["+i+","+oTD_tmp.cellIndex+"],";if(bDeleteColumn){alert(getTxt("Cannot delete column."));return}}}else{if(bDoInsertColumnLeft||bDoInsertColumnRight){oTD_tmp.setAttribute("COLSPAN",cSpan+1)}if(bDeleteColumn){alert(getTxt("Cannot delete column."));return}}bFinish=true}}}}var arrCols=eval("["+sArrCols.substring(0,sArrCols.length-1)+"]");if(bGetArrayCells){return arrCols}if(bDeleteColumn){for(var i=0;i<arrCols.length;i++){var rowIndex=arrCols[i][0];var colIndex=arrCols[i][1];oTable.rows[rowIndex].deleteCell(colIndex)}var it=0;while(it<oTable.rows.length){if(oTable.rows[it].cells.length==0){oTable.deleteRow(it)}else{it++}}if(oTable.rows.length==0){oTable.parentNode.removeChild(oTable)}}parent.oUtil.obj.focus()}function rowOperation(bGetArrayCells,bDoInsertRowAbove,bDoInsertRowBelow,bDeleteRow){var oEditor=parent.oUtil.oEditor;var oSel=oEditor.getSelection();var element=parent.getSelectedElement(oSel);var oTD=GetElement(element,"TD");if(oTD==null){return}var oTR=GetElement(element,"TR");if(oTR==null){return}var oTable=GetElement(element,"TABLE");if(oTable==null){return}if(bGetArrayCells){var sTmp="[";for(var i=0;i<oTR.cells.length;i++){sTmp+="["+oTR.rowIndex+","+oTR.cells[i].cellIndex+"],"}sTmp=sTmp.substr(0,sTmp.length-1)+"]";return eval(sTmp)}var bCannotDelete=false;var numOfCols=getNumOfColumns(oTable);var sTmp="[";for(var i=1;i<=numOfCols;i++){sTmp+="[null,false],"}sTmp=sTmp.substr(0,sTmp.length-1);sTmp+="]";var arrAllCols=eval(sTmp);for(var i=0;i<oTR.rowIndex;i++){var oTR_tmp=oTable.rows[i];var m=0;for(var j=0;j<oTR_tmp.cells.length;j++){var oTD_tmp=oTR_tmp.cells[j];var cSpan=getSpanNum(oTD_tmp.getAttribute("COLSPAN"));m+=cSpan;if(getSpanNum(oTD_tmp.getAttribute("ROWSPAN"))>=oTR.rowIndex+1-i){for(var k=0;k<cSpan;k++){arrAllCols[m-1+k][0]=oTD_tmp;arrAllCols[m-1+k][1]=true;if(bDeleteRow){alert(getTxt("Cannot delete row."));return}}}}}nCount=0;for(var i=0;i<oTR.cells.length;i++){var oTD_tmp=oTR.cells[i];var cSpan=getSpanNum(oTD_tmp.getAttribute("COLSPAN"));while(arrAllCols[nCount][0]!=null){nCount++}if(nCount<=numOfCols){if(bDoInsertRowAbove){for(var j=0;j<cSpan;j++){arrAllCols[nCount+j][0]=oTD_tmp;arrAllCols[nCount+j][1]=false}nCount=nCount+j}if(bDoInsertRowBelow){if(getSpanNum(oTD_tmp.getAttribute("ROWSPAN"))>1){for(var j=0;j<cSpan;j++){arrAllCols[nCount+j][0]=oTD_tmp;arrAllCols[nCount+j][1]=true}}else{for(var j=0;j<cSpan;j++){arrAllCols[nCount+j][0]=oTD_tmp;arrAllCols[nCount+j][1]=false}}nCount=nCount+j}}}if(bDoInsertRowAbove){var oNewRow=oTable.insertRow(oTR.rowIndex)}if(bDoInsertRowBelow){var oNewRow=oTable.insertRow(oTR.rowIndex+1)}var oTD_Prev=null;for(var i=0;i<arrAllCols.length;i++){var oTD_tmp=arrAllCols[i][0];if(oTD_tmp!=oTD_Prev){if(bDoInsertRowAbove||bDoInsertRowBelow){if(arrAllCols[i][1]==true){oTD_tmp.setAttribute("ROWSPAN",getSpanNum(oTD_tmp.getAttribute("ROWSPAN"))+1)}else{oNewTD=oNewRow.insertCell(oNewRow.cells.length);oNewTD.style.cssText=oTD_tmp.style.cssText;oNewTD.innerHTML="New Cell";oNewTD.setAttribute("COLSPAN",getSpanNum(oTD_tmp.getAttribute("COLSPAN")))}}}oTD_Prev=oTD_tmp}if(bDeleteRow){oTable.deleteRow(oTR.rowIndex);if(oTable.rows.length==0){oTable.parentNode.removeChild(oTable)}}parent.oUtil.obj.focus()};